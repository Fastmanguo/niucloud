import{d as e,r as a,S as l,y as t,Z as s,bE as n,a7 as o,aQ as i,ax as u,aK as r,aL as d,ck as c,_ as v,o as f,e as x,w as y,n as h,bu as p,h as g,a0 as m,a1 as b,am as _,a2 as w,cl as k,i as C,cm as T,B as S,Q as E,s as B,b as $,x as D,c as A,$ as I,l as R,aZ as H,U as L,ac as N,f as M,p as z,t as P,u as U,cn as V,co as j,E as O,cp as Q,cq as Z,bX as q,af as G}from"./index-VHk1sExB.js";const K=v(e({name:"l-drag",externalClasses:["l-class"],options:{addGlobalClass:!0,virtualHost:!0},props:{list:{type:Array,default:[]},column:{type:Number,default:2},aspectRatio:Number,gridHeight:{type:[Number,String],default:"120rpx"},damping:{type:Number,default:40},friction:{type:Number,default:2},extraRow:{type:Number,default:0},ghost:Boolean,handle:Boolean,touchHandle:Boolean,before:Boolean,after:Boolean,disabled:Boolean,longpress:Boolean},emits:["change"],setup(e,{emit:v,expose:f}){const x=d(),y=a(!1),h=a(!1),p=a(!0),g=a(-1),m=a(-1),b=a(-1),_=a(!0),w=a(!(!e.handle&&!e.longpress)),k=l({content:null,index:0,oldindex:-1,lastindex:-1}),C=l({content:null,x:0,y:0}),T=l({x:0,y:0}),S=l({x:0,y:0});let E=[];const B=a(0),$=a([]),D=a(0),A=t((()=>(e.before?1:0)+(e.after?1:0))),I=t((()=>Math.ceil(((h.value?$.value.length:e.list.length)+A.value)/e.column))),R=t((()=>e.aspectRatio?H.value/e.aspectRatio:/rpx$/.test(`${e.gridHeight}`)?i(parseInt(`${e.gridHeight}`)):parseInt(`${e.gridHeight}`))),H=t((()=>B.value/e.column)),L=t((()=>({width:H.value+"px",height:R.value+"px"}))),N=t((()=>({height:(I.value+D.value)*R.value+"px"}))),M=t((()=>({height:(I.value+e.extraRow+D.value)*R.value+"px"}))),z=(e,a=1e3/60)=>setTimeout(e,a),P=(a,l)=>{g.value++,b.value++;const t=b.value,s=E[t];let n=0,o=0;if(s){if(e.after){let a=E[t+1];a||(a=O(E.length+(e.before?1:0)),E.push(a)),U((()=>V(a)))}else U();n=s.x,o=s.y}else{const a=O(E.length+(e.before?1:0));E.push(a),U(),n=a.x,o=a.y}return l&&(n=l.x,o=l.y),{id:`l-drag-item-${g.value}`,index:t,oldindex:t,content:a,x:n,y:o,class:"",show:!0}},U=e=>{h.value&&e&&z(e)},V=({x:a,y:l}={x:0,y:0})=>{e.after&&(S.x=a,S.y=l)},j=(a,l=!1)=>{const t=`${a.type}`.toLowerCase(),{handle:s=e.touchHandle}=a.target.dataset;e.handle&&!s?w.value=!0:e.handle&&s&&!e.longpress?w.value=l:(e.handle&&s&&e.longpress&&t.includes("longpress")||e.longpress&&t.includes("longpress")&&!e.handle)&&(w.value=!1),t.includes("touchend")&&e.longpress&&(w.value=!0)},O=(a,l)=>{let{row:t}=l||E[E.length-1]||{row:0};const s=a%e.column;return 0==s&&0!=a&&t++,n=t,o=s*H.value,i=t*R.value,{row:n,x:o,y:i,x1:o+H.value,y1:i+R.value};var n,o,i},Q=()=>{const e=[...$.value].sort(((e,a)=>e.index-a.index));v("change",e)},Z=(e,a,l,t=!0)=>{if(a>$.value.length-1||a<0)return;const s=(e=>y.value?k:$.value[e])(e);let n=0,o=s.index;if(o<a&&(n=1),o>a&&(n=-1),!n)return;let i=o-a;for(;i;){i+=n;const u=y.value?s.index+=n:o+=n;let r=$.value.findIndex((e=>e.index==u&&e.content!=s.content));if(r==e)return;r<0&&(r=$.value.length-1);let d=$.value[r];if(!d)return;const c=u-n,v=$.value[e],f=E[c];if(d.x=f.x,d.y=f.y,d.oldindex=d.index,d.index=c,v.oldindex=v.index,v.index=a,!i&&!y.value){const e=E[a],{x:n,y:o}=l||e;v.x=s.x=n,v.y=s.y=o,t&&Q()}}},q=(e,a)=>{m.value=-1,y.value=!1,Z(e,a)};let G=null;const K=a=>{m.value=-1,y.value=!1,clearTimeout(G);const l=$.value[a];if(e.disabled||!l)return;l.show=!1;const t=$.value.length-1;Z(a,t,l,!1),V(E[t]),b.value--;((l=a)=>{const t=Math.ceil(($.value.length-1+A.value)/e.column);t<I.value&&(D.value=I.value-t),$.value.splice(l,1)[0],Q(),G=setTimeout((()=>{D.value=0}),400)})()},X=(...a)=>{e.disabled||Array.isArray(a)&&Promise.all(a.map((async e=>await F(e,!0)))).then(Q)},F=(e,a)=>new Promise((l=>{const t=P(e,a?null:{x:-100,y:0});t.class="l-drag-enter",$.value.push(t);const s=$.value.length-1;u((()=>{z((()=>{t.class="l-drag-leave",Z(s,a?s:0,null,!1),c($),l(!0)}))}))})),J=(...a)=>{e.disabled||Array.isArray(a)&&Promise.all(a.map((async e=>await F(e)))).then(Q)},W=()=>{h.value=y.value=!1,b.value=g.value=m.value=-1,$.value=[],E=[]},Y=()=>{W(),(()=>{let a=[];const l=I.value*e.column+A.value;E=[];for(var t=0;t<l;t++){const e=O(t,a[a.length-1]);a.push(e)}if(e.before){const{x:e,y:l}=a.shift();T.x=e,T.y=l}V(a[e.list.length]),E=a})(),u((()=>{var a;a=e.list,$.value=a.map((e=>P(e))),h.value=!0}))};return s((()=>{r().in(x.proxy).select(".l-drag").boundingClientRect((e=>{e&&(B.value=e.width||0,Y())})).exec()})),n(W),o((()=>e.list),Y),f({remove:K,move:q,push:X,unshift:J,shift:()=>{$.value.length&&K($.value.findIndex((e=>0==e.index))||0)},pop:()=>{const e=$.value.length-1;e<0||K($.value.findIndex((a=>a.index==e))||e)}}),{cloneList:$,areaStyles:N,innerStyles:M,viewStyles:L,setDisabled:j,isDisabled:w,isReset:p,isDrag:y,active:m,animation:_,afterEl:S,ghostEl:C,beforeEl:T,touchStart:e=>{var a,l;if(e.target.dataset.remove)return;const{oindex:t}=(null==(a=e.currentTarget)?void 0:a.dataset)||(null==(l=e.target)?void 0:l.dataset)||{};if("number"!=typeof t)return;const s=$.value[t];y.value=!0,m.value=t,k.index=k.oldindex=s.index,C.x=s.x||0,C.y=s.y||0,k.content=C.content=s.content},touchMove:e=>{if(!y.value)return;let{oindex:a}=e.currentTarget.dataset;if(a!=m.value)return;const{x:l,y:t}=e.detail,s=l+H.value/2,n=t+R.value/2;for(let o=0;o<$.value.length;o++){const e=E[o];if(s>e.x&&s<e.x1&&n>e.y&&n<e.y1){C.x=e.x,C.y=e.y,k.index!=o&&Z(m.value,o);break}}},touchEnd:e=>{setTimeout((()=>{if(e.target.dataset.remove||-1==m.value)return;j(e,!0),y.value=!1;const a=k.index!==k.oldindex&&k.oldindex>-1;k.lastindex=m.value,k.oldindex=m.value=-1;const l=$.value[k.lastindex],t=E[k.index];u((()=>{l.x=t.x+.001,l.y=t.y+.001,z((()=>{l.x=t.x,l.y=t.y,a&&Q()}))}))}),80)},remove:K,move:q,push:X,unshift:J,props:e}}}),[["render",function(e,a,l,t,s,n){const o=k,i=C,u=T;return f(),x(i,{class:"l-drag l-class",style:h([e.areaStyles]),ref:"dragRef",onTouchstart:e.setDisabled},{default:y((()=>[e.isReset?(f(),x(u,{key:0,class:"l-drag__inner",style:h([e.innerStyles])},{default:y((()=>[p(e.$slots,"default",{},void 0,!0),e.isDrag&&e.props.ghost?(f(),x(o,{class:"l-drag__ghost",animation:!0,style:h([e.viewStyles]),direction:"all",x:e.ghostEl.x,y:e.ghostEl.y,key:"l-drag-clone"},{default:y((()=>[p(e.$slots,"ghost",{},void 0,!0)])),_:3},8,["style","x","y"])):g("",!0),e.props.before?(f(),x(o,{key:1,class:"l-drag__before",disabled:"",animation:!1,style:h([e.viewStyles]),x:e.beforeEl.x,y:e.beforeEl.y},{default:y((()=>[p(e.$slots,"before",{},void 0,!0)])),_:3},8,["style","x","y"])):g("",!0),(f(!0),m(b,null,_(e.cloneList,((a,l)=>(f(),x(o,{key:a.id,direction:"all","data-oindex":l,style:h([e.viewStyles]),class:w(["l-drag__view",[{"l-is-active":l==e.active,"l-is-hidden":!a.show},a.class]]),x:a.x,y:a.y,friction:e.friction,damping:e.damping,animation:e.animation,disabled:e.isDisabled||e.props.disabled,onTouchstart:e.touchStart,onChange:e.touchMove,onTouchend:e.touchEnd,onTouchcancel:e.touchEnd,onLongpress:e.setDisabled},{default:y((()=>[p(e.$slots,"grid",{oindex:l,index:a.index,oldindex:a.oldindex,content:a.content,active:!e.isDisabled&&!e.isDisabled&&l==e.active},void 0,!0),e.isDisabled||e.props.disabled||!e.props.longpress?g("",!0):(f(),x(i,{key:0,class:"mask"}))])),_:2},1032,["data-oindex","style","class","x","y","friction","damping","animation","disabled","onTouchstart","onChange","onTouchend","onTouchcancel","onLongpress"])))),128)),e.props.after?(f(),x(o,{key:2,class:"l-drag__after",disabled:"",animation:!0,direction:"all",style:h([e.viewStyles]),x:e.afterEl.x,y:e.afterEl.y},{default:y((()=>[p(e.$slots,"after",{},void 0,!0)])),_:3},8,["style","x","y"])):g("",!0)])),_:3},8,["style"])):g("",!0)])),_:3},8,["style","onTouchstart"])}],["__scopeId","data-v-bf0b13c6"]]),X=v(e({__name:"edit",setup(e){const t=a(!1),s=a([{name:"编辑",value:1,color:"#303133",fontSize:"14"},{name:"删除",value:2,color:"#ef4444",fontSize:"14"}]),n=e=>{1===e.value?u.value=!0:V({key:o.key,id:o.form.id}).then((()=>{c()}))},o=l({list:[],config:null,loading:!0,form:{id:null,value:"",key:null},key:null}),i=e=>{let a=[],l=0,t=e.map((e=>(a.push({id:e.id,sort:l++}),e.content)));o.list=t,j({key:o.key,list:a}).then((e=>{O({title:B("success"),icon:"success"})}))},u=a(!1),r=()=>{u.value=!0,o.form.id=null,o.form.value=""},d=()=>{if(""==o.form.value)return O({title:B("form.check_data"),icon:"none"});(o.form.id?Q:Z)(o.form).then((e=>{O({title:B("success"),icon:"none"}),u.value=!1,c()}))},c=()=>{q(o.key).then((e=>{o.list=G(e.data.list),delete e.data.list,o.config=e.data,o.form.key=o.key,o.loading=!1})).catch((e=>{o.loading=!1,E({title:B(e.msg)})}))};return S((e=>{e.key?(o.key=e.key,c()):E({title:B("system_error")})})),(e,a)=>{const l=$(A("up-navbar"),D),c=$(A("up-button"),I),v=C,p=$(A("up-icon"),R),_=$(A("l-drag"),K),k=$(A("up-action-sheet"),H),T=$(A("up-input"),L),S=$(A("up-modal"),N);return f(),m(b,null,[M(v,{style:h(e.themeColor())},{default:y((()=>[M(l,{title:e.title,autoBack:!0,safeAreaInsetTop:!0,placeholder:!0},null,8,["title"]),M(v,{class:"main p-3 bg-[#fff]"},{default:y((()=>[o.config&&o.config.write?(f(),x(c,{key:0,text:"添加",onClick:r,plain:"",icon:"/static/assets/add.png",iconColor:"#e0b87a",class:"!text-[#303133]"})):g("",!0),M(v,{class:"flex text-sm mt-5 my-2"},{default:y((()=>[z(" 已添加 "),M(v,{class:"text-[#909399]"},{default:y((()=>[z("（长按数据可调节排序）")])),_:1})])),_:1}),M(_,{list:o.list,onChange:i,column:1,"grid-height":"50px",longpress:""},{grid:y((({active:e,content:a})=>[M(v,{class:w(["flex justify-between items-center px-[10px] py-2 bg-[#f9fafb] mb-5 box-border text-[#303133] rounded-[5px]",{active:e}])},{default:y((()=>[z(P(a.value)+" ",1),M(v,null,{default:y((()=>[M(p,{name:"more-dot-fill",color:"#303133",bold:"",size:"15",onClick:e=>{return l=a,t.value=!0,o.form.id=l.id,void(o.form.value=l.value);var l}},null,8,["onClick"])])),_:2},1024)])),_:2},1032,["class"])])),_:1},8,["list"])])),_:1})])),_:1},8,["style"]),M(k,{actions:s.value,show:t.value,cancelText:"取消",safeAreaInsetBottom:!0,onSelect:n,closeOnClickOverlay:!0,round:"0",onClose:a[0]||(a[0]=e=>t.value=!1)},null,8,["actions","show"]),M(S,{show:u.value,"onUpdate:show":a[3]||(a[3]=e=>u.value=e),width:300,showConfirmButton:!1,contentTextAlign:"center"},{confirmButton:y((()=>[M(v,{class:"flex gap-2"},{default:y((()=>[M(c,{onClick:a[2]||(a[2]=e=>u.value=!1),class:"!text-[#303133]",color:"#f4f5f7",text:"取消"}),M(c,{text:"确定",onClick:d,color:"#e0b87a"})])),_:1})])),default:y((()=>[M(v,{class:"flex flex-col items-center w-full"},{default:y((()=>[M(v,{class:"flex !text-center font-bold text-base mb-3"},{default:y((()=>[z(P(o.form.id?U(B)("base.data.edit"):U(B)("base.data.add")),1)])),_:1}),M(v,{class:"flex flex-col !box-border w-full !bg-[#f4f5f7] p-2 !rounded"},{default:y((()=>[M(T,{placeholder:"最多输入6个字符",border:"none",modelValue:o.form.value,"onUpdate:modelValue":a[1]||(a[1]=e=>o.form.value=e),inputAlign:"center"},null,8,["modelValue"])])),_:1})])),_:1})])),_:1},8,["show"])],64)}}}),[["__scopeId","data-v-3e7bb2e7"]]);export{X as default};
