import{d as e,r as t,W as a,E as l,ac as s,c as o,o as u,i,w as r,f as n,b as p,bI as f,aC as d,ck as m,l as c,e as g,b8 as y,n as h,h as x,p as b,t as v,ak as S,bf as F,co as T,M as _}from"./index-DlbBJ3bC.js";const w=e({__name:"index",props:{text:{type:String,default:""},modelValue:{type:[String,Array],default:()=>null},valueType:{type:String,default:"string"},resultType:{type:String,default:"string"},afterFormatter:{type:Function,default:e=>e},beforeFormatter:{type:Function,default:e=>e},autoUpload:{type:Boolean,default:!0},fileType:{type:String,default:"image"},width:{type:[Number,String],default:80},height:{type:[Number,String],default:80},edit:{type:Boolean,default:!0},max:{type:Number,default:1},min:{type:Number,default:0},iconSize:{type:[Number,String],default:24},tipsSize:{type:[Number,String],default:12},tips:{type:String,default:""}},emits:["update:modelValue","uploadAfter","uploadBefore","upload"],setup(e,{expose:w,emit:z}){const j=e,k=t(),N=z,B=a({data:[],dataUpload:[],temp:{},edit:!1,max:0}),E=e=>void 0!==A[e]?{url:A[e],value:e,status:""}:{url:_(e),value:e,status:""},A={},R=l({get(){let e=[...B.data,...Object.values(B.temp)];return j.edit?B.max=j.max:B.max=e.length,console.log("展示数据有更新",B,e),e},set(e){}}),V=e=>{console.log(e)};let C=!1;const O=m((()=>{console.log("更新数据",B);let e=[];B.data.forEach((t=>{e.push(t.value)})),Object.keys(B.temp).forEach((t=>{"success"==B.temp[t].status&&(e.push(B.temp[t].value),delete B.temp[t])})),"string"==j.valueType&&(e=e.join(",")),j.afterFormatter&&j.afterFormatter instanceof Function&&(e=j.afterFormatter(e)),d((()=>{N("update:modelValue",e)}))}),100),U=({file:e})=>{e.forEach((e=>{const t=uni.$u.guid(),a={url:e.url,file:e,value:null,status:"",message:""};1==j.max&&B.data.length>=1&&(B.data=[]),B.temp[t]=a,d((()=>{(e=>{if(console.log("上传文件"),j.autoUpload){const t=S(B.temp[e]);N("uploadAfter",t),t.status="uploading";const a="image"==j.fileType?F:T;C=!0,a({filePath:t.url,name:"file"}).then((({data:e})=>{t.value=e.url,A[e.url]=t.url,t.status="success"})).catch((e=>{t.status="failed",t.message=e.msg})).finally((()=>{C=!1,B.temp[e]=t,console.log("上传完成",B),O()}))}})(t)}))}))},L=e=>{if(""==e.file.status)for(let t=0;t<B.data.length;t++)B.data[t].value==e.file.value&&B.data.splice(t,1);else Object.keys(B.temp).forEach((t=>{B.temp[t].url==e.file.url&&delete B.temp[t]}));console.log("删除图片后",B),O()};return s((()=>j.modelValue),(e=>{let t=S(e),a=[];if(!C){if(console.log("根数据有变化",e),t&&j.beforeFormatter&&j.beforeFormatter instanceof Function&&(t=j.beforeFormatter(t)),!t||"string"==j.valueType&&""==t||"array"==j.valueType&&!t.length)return[];if("string"==j.valueType)if(j.max>1){a=t.split(",").map((e=>E(e)))}else a=[E(t)];else"array"==j.valueType&&(a=t.map((e=>E(e))));console.log("根数据有变化-end",a),B.data=S(a)}}),{deep:!0,immediate:!0}),w({chooseFile:()=>{k.value.chooseFile()}}),(e,t)=>{const a=p(g("up-icon"),c),l=i,s=p(g("up-upload"),y);return u(),o(l,{class:"upload-file"},{default:r((()=>[n(s,{ref_key:"uploadRef",ref:k,deletable:j.edit,useBeforeRead:!1,fileList:R.value,maxCount:B.max,accept:j.fileType,onAfterRead:U,onBeforeRead:V,onDelete:L,width:j.width,height:j.height,name:"1",multiple:""},{default:r((()=>[f(e.$slots,"default",{},(()=>[n(l,{class:"flex flex-col justify-center items-center bg-[#f4f5f7]",style:h({width:j.width+"px",height:j.height+"px"})},{default:r((()=>[n(a,{size:j.iconSize,name:"camera-fill",color:"var(--theme-color-primary)"},null,8,["size"]),j.tips?(u(),o(l,{key:0,class:"text-[#999]",style:h({fontSize:j.tipsSize+"px"})},{default:r((()=>[b(v(j.tips),1)])),_:1},8,["style"])):x("",!0)])),_:1},8,["style"])]))])),_:3},8,["deletable","fileList","maxCount","accept","width","height"])])),_:3})}}});export{w as _};
