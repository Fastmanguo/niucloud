import{d as e,r as a,W as l,E as t,a$ as s,a3 as n,cw as o,ac as i,aC as u,aS as r,aT as d,cx as c,_ as v,c as f,o as x,w as y,h,cy as p,n as g,bI as m,a5 as b,cz as _,a6 as w,at as k,a7 as C,i as T,H as S,C as E,s as B,f as D,cd as $,ak as A,b as I,bb as R,e as H,ah as N,D as L,a4 as z,l as M,Y as P,p as V,t as j,u as O,cA as U,K as G,cB as K,cC as W,cD as Y}from"./index-DlbBJ3bC.js";const q=v(e({name:"l-drag",externalClasses:["l-class"],options:{addGlobalClass:!0,virtualHost:!0},props:{list:{type:Array,default:[]},column:{type:Number,default:2},aspectRatio:Number,gridHeight:{type:[Number,String],default:"120rpx"},damping:{type:Number,default:40},friction:{type:Number,default:2},extraRow:{type:Number,default:0},ghost:Boolean,handle:Boolean,touchHandle:Boolean,before:Boolean,after:Boolean,disabled:Boolean,longpress:Boolean},emits:["change"],setup(e,{emit:v,expose:f}){const x=d(),y=a(!1),h=a(!1),p=a(!0),g=a(-1),m=a(-1),b=a(-1),_=a(!0),w=a(!(!e.handle&&!e.longpress)),k=l({content:null,index:0,oldindex:-1,lastindex:-1}),C=l({content:null,x:0,y:0}),T=l({x:0,y:0}),S=l({x:0,y:0});let E=[];const B=a(0),D=a([]),$=a(0),A=t((()=>(e.before?1:0)+(e.after?1:0))),I=t((()=>Math.ceil(((h.value?D.value.length:e.list.length)+A.value)/e.column))),R=t((()=>e.aspectRatio?H.value/e.aspectRatio:/rpx$/.test(`${e.gridHeight}`)?s(parseInt(`${e.gridHeight}`)):parseInt(`${e.gridHeight}`))),H=t((()=>B.value/e.column)),N=t((()=>({width:H.value+"px",height:R.value+"px"}))),L=t((()=>({height:(I.value+$.value)*R.value+"px"}))),z=t((()=>({height:(I.value+e.extraRow+$.value)*R.value+"px"}))),M=(e,a=1e3/60)=>setTimeout(e,a),P=(a,l)=>{g.value++,b.value++;const t=b.value,s=E[t];let n=0,o=0;if(s){if(e.after){let a=E[t+1];a||(a=U(E.length+(e.before?1:0)),E.push(a)),V((()=>j(a)))}else V();n=s.x,o=s.y}else{const a=U(E.length+(e.before?1:0));E.push(a),V(),n=a.x,o=a.y}return l&&(n=l.x,o=l.y),{id:`l-drag-item-${g.value}`,index:t,oldindex:t,content:a,x:n,y:o,class:"",show:!0}},V=e=>{h.value&&e&&M(e)},j=({x:a,y:l}={x:0,y:0})=>{e.after&&(S.x=a,S.y=l)},O=(a,l=!1)=>{const t=`${a.type}`.toLowerCase(),{handle:s=e.touchHandle}=a.target.dataset;e.handle&&!s?w.value=!0:e.handle&&s&&!e.longpress?w.value=l:(e.handle&&s&&e.longpress&&t.includes("longpress")||e.longpress&&t.includes("longpress")&&!e.handle)&&(w.value=!1),t.includes("touchend")&&e.longpress&&(w.value=!0)},U=(a,l)=>{let{row:t}=l||E[E.length-1]||{row:0};const s=a%e.column;return 0==s&&0!=a&&t++,n=t,o=s*H.value,i=t*R.value,{row:n,x:o,y:i,x1:o+H.value,y1:i+R.value};var n,o,i},G=()=>{const e=[...D.value].sort(((e,a)=>e.index-a.index));v("change",e)},K=(e,a,l,t=!0)=>{if(a>D.value.length-1||a<0)return;const s=(e=>y.value?k:D.value[e])(e);let n=0,o=s.index;if(o<a&&(n=1),o>a&&(n=-1),!n)return;let i=o-a;for(;i;){i+=n;const u=y.value?s.index+=n:o+=n;let r=D.value.findIndex((e=>e.index==u&&e.content!=s.content));if(r==e)return;r<0&&(r=D.value.length-1);let d=D.value[r];if(!d)return;const c=u-n,v=D.value[e],f=E[c];if(d.x=f.x,d.y=f.y,d.oldindex=d.index,d.index=c,v.oldindex=v.index,v.index=a,!i&&!y.value){const e=E[a],{x:n,y:o}=l||e;v.x=s.x=n,v.y=s.y=o,t&&G()}}},W=(e,a)=>{m.value=-1,y.value=!1,K(e,a)};let Y=null;const q=a=>{m.value=-1,y.value=!1,clearTimeout(Y);const l=D.value[a];if(e.disabled||!l)return;l.show=!1;const t=D.value.length-1;K(a,t,l,!1),j(E[t]),b.value--;((l=a)=>{const t=Math.ceil((D.value.length-1+A.value)/e.column);t<I.value&&($.value=I.value-t),D.value.splice(l,1)[0],G(),Y=setTimeout((()=>{$.value=0}),400)})()},F=(...a)=>{e.disabled||Array.isArray(a)&&Promise.all(a.map((async e=>await J(e,!0)))).then(G)},J=(e,a)=>new Promise((l=>{const t=P(e,a?null:{x:-100,y:0});t.class="l-drag-enter",D.value.push(t);const s=D.value.length-1;u((()=>{M((()=>{t.class="l-drag-leave",K(s,a?s:0,null,!1),c(D),l(!0)}))}))})),Q=(...a)=>{e.disabled||Array.isArray(a)&&Promise.all(a.map((async e=>await J(e)))).then(G)},X=()=>{h.value=y.value=!1,b.value=g.value=m.value=-1,D.value=[],E=[]},Z=()=>{X(),(()=>{let a=[];const l=I.value*e.column+A.value;E=[];for(var t=0;t<l;t++){const e=U(t,a[a.length-1]);a.push(e)}if(e.before){const{x:e,y:l}=a.shift();T.x=e,T.y=l}j(a[e.list.length]),E=a})(),u((()=>{var a;a=e.list,D.value=a.map((e=>P(e))),h.value=!0}))};return n((()=>{r().in(x.proxy).select(".l-drag").boundingClientRect((e=>{e&&(B.value=e.width||0,Z())})).exec()})),o(X),i((()=>e.list),Z),f({remove:q,move:W,push:F,unshift:Q,shift:()=>{D.value.length&&q(D.value.findIndex((e=>0==e.index))||0)},pop:()=>{const e=D.value.length-1;e<0||q(D.value.findIndex((a=>a.index==e))||e)}}),{cloneList:D,areaStyles:L,innerStyles:z,viewStyles:N,setDisabled:O,isDisabled:w,isReset:p,isDrag:y,active:m,animation:_,afterEl:S,ghostEl:C,beforeEl:T,touchStart:e=>{var a,l;if(e.target.dataset.remove)return;const{oindex:t}=(null==(a=e.currentTarget)?void 0:a.dataset)||(null==(l=e.target)?void 0:l.dataset)||{};if("number"!=typeof t)return;const s=D.value[t];y.value=!0,m.value=t,k.index=k.oldindex=s.index,C.x=s.x||0,C.y=s.y||0,k.content=C.content=s.content},touchMove:e=>{if(!y.value)return;let{oindex:a}=e.currentTarget.dataset;if(a!=m.value)return;const{x:l,y:t}=e.detail,s=l+H.value/2,n=t+R.value/2;for(let o=0;o<D.value.length;o++){const e=E[o];if(s>e.x&&s<e.x1&&n>e.y&&n<e.y1){C.x=e.x,C.y=e.y,k.index!=o&&K(m.value,o);break}}},touchEnd:e=>{setTimeout((()=>{if(e.target.dataset.remove||-1==m.value)return;O(e,!0),y.value=!1;const a=k.index!==k.oldindex&&k.oldindex>-1;k.lastindex=m.value,k.oldindex=m.value=-1;const l=D.value[k.lastindex],t=E[k.index];u((()=>{l.x=t.x+.001,l.y=t.y+.001,M((()=>{l.x=t.x,l.y=t.y,a&&G()}))}))}),80)},remove:q,move:W,push:F,unshift:Q,props:e}}}),[["render",function(e,a,l,t,s,n){const o=_,i=T,u=p;return x(),f(i,{class:"l-drag l-class",style:g([e.areaStyles]),ref:"dragRef",onTouchstart:e.setDisabled},{default:y((()=>[e.isReset?(x(),f(u,{key:0,class:"l-drag__inner",style:g([e.innerStyles])},{default:y((()=>[m(e.$slots,"default",{},void 0,!0),e.isDrag&&e.props.ghost?(x(),f(o,{class:"l-drag__ghost",animation:!0,style:g([e.viewStyles]),direction:"all",x:e.ghostEl.x,y:e.ghostEl.y,key:"l-drag-clone"},{default:y((()=>[m(e.$slots,"ghost",{},void 0,!0)])),_:3},8,["style","x","y"])):h("",!0),e.props.before?(x(),f(o,{key:1,class:"l-drag__before",disabled:"",animation:!1,style:g([e.viewStyles]),x:e.beforeEl.x,y:e.beforeEl.y},{default:y((()=>[m(e.$slots,"before",{},void 0,!0)])),_:3},8,["style","x","y"])):h("",!0),(x(!0),b(w,null,k(e.cloneList,((a,l)=>(x(),f(o,{key:a.id,direction:"all","data-oindex":l,style:g([e.viewStyles]),class:C(["l-drag__view",[{"l-is-active":l==e.active,"l-is-hidden":!a.show},a.class]]),x:a.x,y:a.y,friction:e.friction,damping:e.damping,animation:e.animation,disabled:e.isDisabled||e.props.disabled,onTouchstart:e.touchStart,onChange:e.touchMove,onTouchend:e.touchEnd,onTouchcancel:e.touchEnd,onLongpress:e.setDisabled},{default:y((()=>[m(e.$slots,"grid",{oindex:l,index:a.index,oldindex:a.oldindex,content:a.content,active:!e.isDisabled&&!e.isDisabled&&l==e.active},void 0,!0),e.isDisabled||e.props.disabled||!e.props.longpress?h("",!0):(x(),f(i,{key:0,class:"mask"}))])),_:2},1032,["data-oindex","style","class","x","y","friction","damping","animation","disabled","onTouchstart","onChange","onTouchend","onTouchcancel","onLongpress"])))),128)),e.props.after?(x(),f(o,{key:2,class:"l-drag__after",disabled:"",animation:!0,direction:"all",style:g([e.viewStyles]),x:e.afterEl.x,y:e.afterEl.y},{default:y((()=>[m(e.$slots,"after",{},void 0,!0)])),_:3},8,["style","x","y"])):h("",!0)])),_:3},8,["style"])):h("",!0)])),_:3},8,["style","onTouchstart"])}],["__scopeId","data-v-bf0b13c6"]]),F=v(e({__name:"edit",setup(e){const t=a(!1),s=a([{name:"编辑",value:1,color:"#303133",fontSize:"14"},{name:"删除",value:2,color:"#ef4444",fontSize:"14"}]),n=e=>{1===e.value?u.value=!0:Y({key:o.key,id:o.form.id}).then((()=>{c()}))},o=l({list:[],config:null,loading:!0,form:{id:null,value:"",key:null},key:null}),i=e=>{let a=[],l=0,t=e.map((e=>(a.push({id:e.id,sort:l++}),e.content)));o.list=t,U({key:o.key,list:a}).then((e=>{G({title:B("success"),icon:"success"})}))},u=a(!1),r=()=>{u.value=!0,o.form.id=null,o.form.value=""},d=()=>{if(""==o.form.value)return G({title:B("form.check_data"),icon:"none"});(o.form.id?K:W)(o.form).then((e=>{G({title:B("success"),icon:"none"}),u.value=!1,c()}))},c=()=>{$(o.key).then((e=>{o.list=A(e.data.list),delete e.data.list,o.config=e.data,o.form.key=o.key,o.loading=!1})).catch((e=>{o.loading=!1,E({title:B(e.msg)})}))};return S((e=>{e.key?(o.key=e.key,c()):E({title:B("system_error")})})),(e,a)=>{const l=I(H("up-navbar"),L),c=I(H("up-button"),z),v=T,p=I(H("up-icon"),M),m=I(H("l-drag"),q),_=I(H("up-action-sheet"),R),k=I(H("up-input"),P),S=I(H("up-modal"),N);return x(),b(w,null,[D(v,{style:g(e.themeColor())},{default:y((()=>[D(l,{title:e.title,autoBack:!0,safeAreaInsetTop:!0,placeholder:!0},null,8,["title"]),D(v,{class:"main p-3 bg-[#fff]"},{default:y((()=>[o.config&&o.config.write?(x(),f(c,{key:0,text:"添加",onClick:r,plain:"",icon:"/static/assets/add.png",iconColor:"#e0b87a",class:"!text-[#303133]"})):h("",!0),D(v,{class:"flex text-sm mt-5 my-2"},{default:y((()=>[V(" 已添加 "),D(v,{class:"text-[#909399]"},{default:y((()=>[V("（长按数据可调节排序）")])),_:1})])),_:1}),D(m,{list:o.list,onChange:i,column:1,"grid-height":"50px",longpress:""},{grid:y((({active:e,content:a})=>[D(v,{class:C(["flex justify-between items-center px-[10px] py-2 bg-[#f9fafb] mb-5 box-border text-[#303133] rounded-[5px]",{active:e}])},{default:y((()=>[V(j(a.value)+" ",1),D(v,null,{default:y((()=>[D(p,{name:"more-dot-fill",color:"#303133",bold:"",size:"15",onClick:e=>{return l=a,t.value=!0,o.form.id=l.id,void(o.form.value=l.value);var l}},null,8,["onClick"])])),_:2},1024)])),_:2},1032,["class"])])),_:1},8,["list"])])),_:1})])),_:1},8,["style"]),D(_,{actions:s.value,show:t.value,cancelText:"取消",safeAreaInsetBottom:!0,onSelect:n,closeOnClickOverlay:!0,round:"0",onClose:a[0]||(a[0]=e=>t.value=!1)},null,8,["actions","show"]),D(S,{show:u.value,"onUpdate:show":a[3]||(a[3]=e=>u.value=e),width:300,showConfirmButton:!1,contentTextAlign:"center"},{confirmButton:y((()=>[D(v,{class:"flex gap-2"},{default:y((()=>[D(c,{onClick:a[2]||(a[2]=e=>u.value=!1),class:"!text-[#303133]",color:"#f4f5f7",text:"取消"}),D(c,{text:"确定",onClick:d,color:"#e0b87a"})])),_:1})])),default:y((()=>[D(v,{class:"flex flex-col items-center w-full"},{default:y((()=>[D(v,{class:"flex !text-center font-bold text-base mb-3"},{default:y((()=>[V(j(o.form.id?O(B)("base.data.edit"):O(B)("base.data.add")),1)])),_:1}),D(v,{class:"flex flex-col !box-border w-full !bg-[#f4f5f7] p-2 !rounded"},{default:y((()=>[D(k,{placeholder:"最多输入6个字符",border:"none",modelValue:o.form.value,"onUpdate:modelValue":a[1]||(a[1]=e=>o.form.value=e),inputAlign:"center"},null,8,["modelValue"])])),_:1})])),_:1})])),_:1},8,["show"])],64)}}}),[["__scopeId","data-v-3e7bb2e7"]]);export{F as default};
